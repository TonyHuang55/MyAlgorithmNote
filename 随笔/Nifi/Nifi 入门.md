# Nifi 入门
## Nifi 的概念
### Nifi 是什么？
```
Nifi was built to automate the flow of data between system.
```

一个用来处理数据集成场景的数据分发，BS 结构图形化控制工具。

#### Nifi 的特点：
1. 高可用
2. 高性能高并发
3. 错误纠察
4. 快速响应
5. 兼容各种数据格式
6. 安全性
7. 方便迁移

### Nifi 核心概念

| Nifi 术语| FBP 术语|描述|
|---|:---|---|
| FlowFile           | Information Package<br>（信息包） | attribute 键值对 + content|
| FlowFile Processor | Black Box<br>（黑盒）             | 处理 FlowFile ，进行逻辑判断、路由、转换等操作|
| Connection         | Bounded Buffer<br>（缓冲区）      | 连接不同的处理器；<br>充当队列|
| Flow Controller    | Scheduler<br>（调度器）           | 代理角色，调度促进处理器流文件交换|
| Process Group      | subnet<br>（分支网络）            | 包含了一组特定的处理器和连接；<br>组和组也可以进行连接和传输数据组成新的更大的组 |

#### 该设计模式的优点：
1. 可视化
2. 吞吐量大
3. 高并发
4. 内聚、松耦合
5. 支持背压和压力释放机制
6. 错误处理直观精确
7. 数据流动的流程便于理解跟踪

### Nifi 架构
#### Nifi 主要组件

![](插图/Nifi%20主要组件.PNG)

* 网络服务器
    * 承载 http 命令和控制 API
* 流控制器
    * 整个操作的核心，为组件提供线程、管理调度
* 扩展
    * 在 JVM 中操作执行
* 流文件存储库
    * 存储 flowfile 的状态信息；默认实现是先写入日志，再将日志存盘
* 内容存储库
    * 存储 flowfile 的实际内容
* 源头存储库
    * 存储所有的事件数据；每一个事件数据都保存索引，支持搜索事件

#### Nifi 集群运行

![](插图/Nifi%20集群运行.PNG)

* Cluster Coordinator（集群协调器）
    * 管理节点添加/删除
    * 集群协调器节点宕机后，zk 节点会自动选举得到新的协调器
* Primary Node（主节点）
    * 运行不适合在集群环境中运行的组件，如：读文件
    * 主节点宕机后，zk 节点会自动选举得到新的主节点
* ZooKeeper Client（zk 节点）
    * 故障转移、选举
    * 心跳、状态信息的管理

### Nifi 性能
优化的三个方面：
* 磁盘 IO
* CPU 多线程
* 内存（基于 JVM）

### Nifi 关键特性
* **流管理**
    * **保证交付**：
        
        通过日志和内容存储库实现。它们被设计成允许高事务速率、有效的负载均衡、写时复制和能发挥传统磁盘读/写的优势。
    
    * **数据缓冲 背压和压力释放**：
    
        支持缓冲所有排队的数据，以及在这些队列达到指定限制时提供背压的能力 (背压对象阈值和背压数据大小阈值) ，或在数据达到指定期限 (其值已失效) 时老化丢弃数据的能力。
        
    * **队列优先级**
    
        允许设置一个或多个优先级，用于检索数据。默认先进先出，也有后进先出，最大数据先出等其他定制方案。
        
    * **特殊流质量 (延迟和吞吐量)**
    
        支持细粒度的配置，如：不容丢失的一些节点数据；规定时间内的传输需求。
        
* **易用性**
    * **可视化流程**：
        
        降低数据流的复杂度，便于定位需要简化的地方。Nifi 可以实时实现数据流的可视化建立，更改都会立即生效，且不需要为进行某些修改而停止整个流程或流程组。
        
    * **流模板**：
    
        flowfile 是高度模式化的，便于模板复用
        
    * **数据起源跟踪**
    
        Nifi 会自动记录、索引数据的流转。
        
    * **可以记录和重放的细粒度历史记录缓冲区**
    
        Nifi 的内容存储库旨在充当历史数据的滚动缓存区。数据仅在内容存储库老化或需要空间时才会被删除。内容存储区和数据起源追踪能力相结合，为在对象的生命周期中的特定点 (甚至可以跨越几代) 实现可以查看内容，内容下载和重放等功能提供了非常有用的基础。
        
* **灵活的缩放模型**
    * **水平扩展 (Clustering)**：
        
        加入配置单个节点并将其配置为每秒处理百 MB 数据那么可以将集群配置为每秒处理 GB 级数据。可以采用异步排队的协议 (如消息服务，Kafka 等) 解决 Nifi 和与其获取数据的系统之间的负载平衡和故障转移问题。
        
    * **扩展和缩小**：
    
        在增加吞吐量方面，也已在配置时增加 “调度“ 选项下处理器上的并发任务数，通过允许更多线程同时执行以提供更高的吞吐量；另一方面也可以将其缩小到适合在边缘设备上运行，在资源有限处使用 MININifi 。
       
     

## Nifi 入门