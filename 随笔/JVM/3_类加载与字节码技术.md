# 3_类加载与字节码技术
1. 类文件结构
2. 字节码指令
3. 编译期处理
4. 类加载阶段
5. 类加载器
6. 运行期优化

![概述](插图/3概述.jpg)

## 1. 类文件结构
一个简单的 HelloWorld.java

```java
// HelloWorld 示例
public class HelloWorld {
    public static void main(String[] args) {
        System.out.println("hello world");
    }
}
```

执行 javac -parameters -d . HellowWorld.java

编译为 HelloWorld.class 后是这个样子的：
```
[root@localhost ~]# od -t xC HelloWorld.class
0000000 ca fe ba be 00 00 00 34 00 23 0a 00 06 00 15 09
0000020 00 16 00 17 08 00 18 0a 00 19 00 1a 07 00 1b 07
0000040 00 1c 01 00 06 3c 69 6e 69 74 3e 01 00 03 28 29
0000060 56 01 00 04 43 6f 64 65 01 00 0f 4c 69 6e 65 4e
0000100 75 6d 62 65 72 54 61 62 6c 65 01 00 12 4c 6f 63
0000120 61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65 01
0000140 00 04 74 68 69 73 01 00 1d 4c 63 6e 2f 69 74 63
0000160 61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c 6f
0000200 57 6f 72 6c 64 3b 01 00 04 6d 61 69 6e 01 00 16
0000220 28 5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72
0000240 69 6e 67 3b 29 56 01 00 04 61 72 67 73 01 00 13
0000260 5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69
0000300 6e 67 3b 01 00 10 4d 65 74 68 6f 64 50 61 72 61
0000320 6d 65 74 65 72 73 01 00 0a 53 6f 75 72 63 65 46
0000340 69 6c 65 01 00 0f 48 65 6c 6c 6f 57 6f 72 6c 64
0000360 2e 6a 61 76 61 0c 00 07 00 08 07 00 1d 0c 00 1e
0000400 00 1f 01 00 0b 68 65 6c 6c 6f 20 77 6f 72 6c 64
0000420 07 00 20 0c 00 21 00 22 01 00 1b 63 6e 2f 69 74
0000440 63 61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c
0000460 6f 57 6f 72 6c 64 01 00 10 6a 61 76 61 2f 6c 61
0000500 6e 67 2f 4f 62 6a 65 63 74 01 00 10 6a 61 76 61
0000520 2f 6c 61 6e 67 2f 53 79 73 74 65 6d 01 00 03 6f
0000540 75 74 01 00 15 4c 6a 61 76 61 2f 69 6f 2f 50 72
0000560 69 6e 74 53 74 72 65 61 6d 3b 01 00 13 6a 61 76
0000600 61 2f 69 6f 2f 50 72 69 6e 74 53 74 72 65 61 6d
0000620 01 00 07 70 72 69 6e 74 6c 6e 01 00 15 28 4c 6a
0000640 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 6e 67 3b
0000660 29 56 00 21 00 05 00 06 00 00 00 00 00 02 00 01
0000700 00 07 00 08 00 01 00 09 00 00 00 2f 00 01 00 01
0000720 00 00 00 05 2a b7 00 01 b1 00 00 00 02 00 0a 00
0000740 00 00 06 00 01 00 00 00 04 00 0b 00 00 00 0c 00
0000760 01 00 00 00 05 00 0c 00 0d 00 00 00 09 00 0e 00
0001000 0f 00 02 00 09 00 00 00 37 00 02 00 01 00 00 00
0001020 09 b2 00 02 12 03 b6 00 04 b1 00 00 00 02 00 0a
0001040 00 00 00 0a 00 02 00 00 00 06 00 08 00 07 00 0b
0001060 00 00 00 0c 00 01 00 00 00 09 00 10 00 11 00 00
0001100 00 12 00 00 00 05 01 00 10 00 00 00 01 00 13 00
0001120 00 00 02 00 14
```

根据 JVM 规范，类文件结构如下
```
ClassFile {
    u4 magic;
    u2 minor_version;
    u2 major_version;
    u2 constant_pool_count;
    cp_info constant_pool[constant_pool_count-1];
    u2 access_flags;
    u2 this_class;
    u2 super_class;
    u2 interfaces_count;
    u2 interfaces[interfaces_count];
    u2 fields_count;
    field_info fields[fields_count];
    u2 methods_count;
    method_info methods[methods_count];
    u2 attributes_count;
    attribute_info attributes[attributes_count];
}
```

### 1.1 魔数
0~3 字节，表示它是否是【class】类型的文件

0000000 <font color=red>ca fe ba be</font> 00 00 00 34 00 23 0a 00 06 00 15 09

### 1.2 版本
4~7 字节，表示类的版本 00 34（52） 表示是 Java 8

0000000 ca fe ba be <font color=red>00 00 00 34</font> 00 23 0a 00 06 00 15 09

### 1.3 常量池
|**Constant Type**|**Value**|
|:---|:---|
|CONSTANT_Class|7
|CONSTANT_Fieldref|9
|CONSTANT_Methodref|10
|CONSTANT_InterfaceMethodref|11
|CONSTANT_String|8
|CONSTANT_Integer|3
|CONSTANT_Float|4
|CONSTANT_Long|5
|CONSTANT_Double|6
|CONSTANT_NameAndType|12
|CONSTANT_Utf8|1
|CONSTANT_MethodHandle|15
|CONSTANT_MethodType|16
|CONSTANT_InvokeDynamic|18

8~9 字节，表示常量池长度，00 23 （35） 表示常量池有 #1~#34项，注意 #0 项不计入，也没有值

0000000 ca fe ba be 00 00 00 34 <font color=red>00 23</font> 0a 00 06 00 15 09

<br/>
第#1项 0a 表示一个 Method 信息，00 06 和 00 15（21） 表示它引用了常量池中 #6 和 #21 项来获得这个方法的【所属类】和【方法名】

0000000 ca fe ba be 00 00 00 34 00 23 <font color=red>0a 00 06 00 15</font> 09

<br/>
第#2项 09 表示一个 Field 信息，00 16（22）和 00 17（23） 表示它引用了常量池中 #22 和 # 23 项来获得这个成员变量的【所属类】和【成员变量名】

0000000 ca fe ba be 00 00 00 34 00 23 0a 00 06 00 15 <font color=red>09</font>

0000020 <font color=red>00 16 00 17</font> 08 00 18 0a 00 19 00 1a 07 00 1b 07

<br/>
第#3项 08 表示一个字符串常量名称，00 18（24）表示它引用了常量池中 #24 项

0000020 00 16 00 17 <font color=red>08 00 18</font> 0a 00 19 00 1a 07 00 1b 07

<br/>
第#4项 0a 表示一个 Method 信息，00 19（25） 和 00 1a（26） 表示它引用了常量池中 #25 和 #26项来获得这个方法的【所属类】和【方法名】

0000020 00 16 00 17 08 00 18 <font color=red>0a 00 19 00 1a</font> 07 00 1b 07

<br/>
第#5项 07 表示一个 Class 信息，00 1b（27） 表示它引用了常量池中 #27 项

0000020 00 16 00 17 08 00 18 0a 00 19 00 1a <font color=red>07 00 1b</font> 07

<br/>
第#6项 07 表示一个 Class 信息，00 1c（28） 表示它引用了常量池中 #28 项

0000020 00 16 00 17 08 00 18 0a 00 19 00 1a 07 00 1b <font color=red>07</font>

0000040 <font color=red>00 1c</font> 01 00 06 3c 69 6e 69 74 3e 01 00 03 28 29

<br/>
第#7项 01 表示一个 utf8 串，00 06 表示长度，3c 69 6e 69 74 3e 是【<init>】

0000040 00 1c <font color=red>01 00 06 3c 69 6e 69 74 3e</font> 01 00 03 28 29

<br/>
第#8项 01 表示一个 utf8 串，00 03 表示长度，28 29 56 是【()V】其实就是表示无参、无返回值

0000040 00 1c 01 00 06 3c 69 6e 69 74 3e <font color=red>01 00 03 28 29</font>

0000060 <font color=red>56</font> 01 00 04 43 6f 64 65 01 00 0f 4c 69 6e 65 4e

<br/>
第#9项 01 表示一个 utf8 串，00 04 表示长度，43 6f 64 65 是【Code】

0000060 56 <font color=red>01 00 04 43 6f 64 65</font> 01 00 0f 4c 69 6e 65 4e

<br/>
第#10项 01 表示一个 utf8 串，00 0f（15） 表示长度，4c 69 6e 65 4e 75 6d 62 65 72 54 61 62 6c 65是【LineNumberTable】

0000060 56 01 00 04 43 6f 64 65 <font color=red>01 00 0f 4c 69 6e 65 4e</font>

0000100 <font color=red>75 6d 62 65 72 54 61 62 6c 65</font> 01 00 12 4c 6f 63

<br/>
第#11项 01 表示一个 utf8 串，00 12（18） 表示长度，4c 6f 63 61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65是【LocalVariableTable】

0000100 75 6d 62 65 72 54 61 62 6c 65 <font color=red>01 00 12 4c 6f 63</font>

0000120 <font color=red>61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65</font> 01

<br/>
第#12项 01 表示一个 utf8 串，00 04 表示长度，74 68 69 73 是【this】

0000120 61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65 <font color=red>01</font>

0000140 <font color=red>00 04 74 68 69 73</font> 01 00 1d 4c 63 6e 2f 69 74 63

<br/>
第#13项 01 表示一个 utf8 串，00 1d（29） 表示长度，是【Lcn/itcast/jvm/t5/HelloWorld;】

0000140 00 04 74 68 69 73 <font color=red>01 00 1d 4c 63 6e 2f 69 74 63</font>

0000160 <font color=red>61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c 6f</font>

0000200 <font color=red>57 6f 72 6c 64 3b</font> 01 00 04 6d 61 69 6e 01 00 16

<br/>
第#14项 01 表示一个 utf8 串，00 04 表示长度，74 68 69 73 是【main】

0000200 57 6f 72 6c 64 3b <font color=red>01 00 04 6d 61 69 6e</font> 01 00 16

<br/>
第#15项 01 表示一个 utf8 串，00 16（22） 表示长度，是【([Ljava/lang/String;)V】其实就是参数为字符串数组，无返回值

0000200 57 6f 72 6c 64 3b 01 00 04 6d 61 69 6e <font color=red>01 00 16</font>

0000220 <font color=red>28 5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72</font>

0000240 <font color=red>69 6e 67 3b 29 56</font> 01 00 04 61 72 67 73 01 00 13

<br/>
第#16项 01 表示一个 utf8 串，00 04 表示长度，是【args】

0000240 69 6e 67 3b 29 56 <font color=red>01 00 04 61 72 67 73</font> 01 00 13

<br/>
第#17项 01 表示一个 utf8 串，00 13（19） 表示长度，是【[Ljava/lang/String;】

0000240 69 6e 67 3b 29 56 01 00 04 61 72 67 73 <font color=red>01 00 13</font> 

0000260 <font color=red>5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69</font> 

0000300 <font color=red>6e 67 3b</font> 01 00 10 4d 65 74 68 6f 64 50 61 72 61

<br/>
第#18项 01 表示一个 utf8 串，00 10（16） 表示长度，是【MethodParameters】

0000300 6e 67 3b <font color=red>01 00 10 4d 65 74 68 6f 64 50 61 72 61</font>

0000320 <font color=red>6d 65 74 65 72 73</font> 01 00 0a 53 6f 75 72 63 65 46

<br/>
第#19项 01 表示一个 utf8 串，00 0a（10） 表示长度，是【SourceFile】

0000320 6d 65 74 65 72 73 <font color=red>01 00 0a 53 6f 75 72 63 65 46</font>

0000340 <font color=red>69 6c 65</font> 01 00 0f 48 65 6c 6c 6f 57 6f 72 6c 64

<br/>
第#20项 01 表示一个 utf8 串，00 0f（15） 表示长度，是【HelloWorld.java】

0000340 69 6c 65 <font color=red>01 00 0f 48 65 6c 6c 6f 57 6f 72 6c 64</font>

0000360 <font color=red>2e 6a 61 76 61</font> 0c 00 07 00 08 07 00 1d 0c 00 1e

<br/>
第#21项 0c 表示一个 【名+类型】，00 07 00 08 引用了常量池中 #7 #8 两项

0000360 2e 6a 61 76 61 <font color=red>0c 00 07 00 08</font> 07 00 1d 0c 00 1e

<br/>
第#22项 07 表示一个 Class 信息，00 1d（29） 引用了常量池中 #29 项

0000360 2e 6a 61 76 61 0c 00 07 00 08 <font color=red>07 00 1d</font> 0c 00 1e

<br/>
第#23项 0c 表示一个 【名+类型】，00 1e（30） 00 1f （31）引用了常量池中 #30 #31 两项

0000360 2e 6a 61 76 61 0c 00 07 00 08 07 00 1d <font color=red>0c 00 1e</font>

0000400 <font color=red>00 1f</font> 01 00 0b 68 65 6c 6c 6f 20 77 6f 72 6c 64

<br/>
第#24项 01 表示一个 utf8 串，00 0f（15） 表示长度，是【hello world】

0000400 00 1f <font color=red>01 00 0b 68 65 6c 6c 6f 20 77 6f 72 6c 64</font>

<br/>
第#25项 07 表示一个 Class 信息，00 20（32） 引用了常量池中 #32 项

0000420 <font color=red>07 00 20</font> 0c 00 21 00 22 01 00 1b 63 6e 2f 69 74

<br/>
第#26项 0c 表示一个 【名+类型】，00 21（33） 00 22（34）引用了常量池中 #33 #34 两项

0000420 07 00 20 <font color=red>0c 00 21 00 22</font> 01 00 1b 63 6e 2f 69 74

<br/>
第#27项 01 表示一个 utf8 串，00 1b（27） 表示长度，是【cn/itcast/jvm/t5/HelloWorld】

0000420 07 00 20 0c 00 21 00 22 <font color=red>01 00 1b 63 6e 2f 69 74</font>

0000440 <font color=red>63 61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c</font>

0000460 <font color=red>6f 57 6f 72 6c 64</font> 01 00 10 6a 61 76 61 2f 6c 61

<br/>
第#28项 01 表示一个 utf8 串，00 10（16） 表示长度，是【java/lang/Object】

0000460 6f 57 6f 72 6c 64 <font color=red>01 00 10 6a 61 76 61 2f 6c 61</font>

0000500 <font color=red>6e 67 2f 4f 62 6a 65 63 74</font> 01 00 10 6a 61 76 61

<br/>
第#29项 01 表示一个 utf8 串，00 10（16） 表示长度，是【java/lang/System】

0000500 6e 67 2f 4f 62 6a 65 63 74 <font color=red>01 00 10 6a 61 76 61</font>

0000520 <font color=red>2f 6c 61 6e 67 2f 53 79 73 74 65 6d</font> 01 00 03 6f

<br/>
第#30项 01 表示一个 utf8 串，00 03 表示长度，是【out】

0000520 2f 6c 61 6e 67 2f 53 79 73 74 65 6d <font color=red>01 00 03 6f</font>

0000540 <font color=red>75 74</font> 01 00 15 4c 6a 61 76 61 2f 69 6f 2f 50 72

<br/>
第#31项 01 表示一个 utf8 串，00 15（21） 表示长度，是【java/io/PrintStream;】

0000540 75 74 <font color=red>01 00 15 4c 6a 61 76 61 2f 69 6f 2f 50 72</font>

0000560 <font color=red>69 6e 74 53 74 72 65 61 6d 3b</font> 01 00 13 6a 61 76

<br/>
第#32项 01 表示一个 utf8 串，00 13（19） 表示长度，是【java/io/PrintStream】

0000560 69 6e 74 53 74 72 65 61 6d 3b <font color=red>01 00 13 6a 61 76</font>

0000600 <font color=red>61 2f 69 6f 2f 50 72 69 6e 74 53 74 72 65 61 6d</font>

<br/>
第#33项 01 表示一个 utf8 串，00 07 表示长度，是【println】

0000620 <font color=red>01 00 07 70 72 69 6e</font> 74 6c 6e 01 00 15 28 4c 6a

<br/>
第#34项 01 表示一个 utf8 串，00 15（21） 表示长度，是【(Ljava/lang/String;)V】

0000620 01 00 07 70 72 69 6e 74 6c 6e <font color=red>01 00 15 28 4c 6a</font>

0000640 <font color=red>61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 6e 67 3b</font>

0000660 <font color=red>29 56</font> 00 21 00 05 00 06 00 00 00 00 00 02 00 01

